<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, height=device-height">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>محرر النصوص على الصور</title>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    
    <style>
        /* تحسينات جديدة */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* منع resize عند ظهور لوحة المفاتيح */
        html {
            height: 100vh;
            height: -webkit-fill-available;
            overscroll-behavior: none;
        }
        
        body {
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overscroll-behavior: none;
        }
        
        /* تحسينات للنص */
        .text-overlay {
            cursor: text;
            min-height: 60px;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }
        
        .text-overlay:empty::before {
            content: attr(data-placeholder);
            color: rgba(255,255,255,0.6);
            pointer-events: none;
        }
        
        .text-overlay:focus {
            outline: none;
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        /* تحسينات للصور */
        .image-item img,
        .category-item img {
            filter: saturate(1.1) contrast(1.05) brightness(1.05);
            transition: all 0.3s ease;
        }
        
        .image-item:hover img,
        .category-item:hover img {
            filter: saturate(1.2) contrast(1.1) brightness(1.1);
            transform: scale(1.03);
        }
        
        /* تحسينات عامة للوحة المفاتيح */
        .keyboard-open body {
            height: 100vh !important;
            overflow: hidden !important;
            position: fixed !important;
            width: 100% !important;
        }
        
        .keyboard-open #editorPage {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            overflow: hidden !important;
            height: 100vh !important;
        }
    </style>
    
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- صفحة الفئات -->
    <div id="categoriesPage" class="page active">
        <div class="header">
            <h1>اختر فئة</h1>
        </div>
        <div class="categories-grid" id="categoriesGrid"></div>
    </div>

    <!-- صفحة الصور -->
    <div id="imagesPage" class="page">
        <div class="header">
            <button onclick="showPage('categories')" class="icon-btn back-btn">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h1 id="categoryTitle">الصور</h1>
        </div>
        <div class="image-grid" id="imageGrid"></div>
    </div>

    <!-- صفحة المحرر -->
    <div id="editorPage" class="page">
        <div class="header">
            <button onclick="goBackToImages()" class="icon-btn back-btn">
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <h1 data-lang="edit">تحرير</h1>
            <div class="header-actions">
                <button onclick="shareImage()" class="icon-btn" title="مشاركة" id="shareBtn">
                    <span class="material-symbols-outlined">share</span>
                </button>
                <button onclick="downloadImage()" class="icon-btn" title="تنزيل" id="downloadBtn">
                    <span class="material-symbols-outlined">download</span>
                </button>
            </div>
        </div>
        
        <!-- إضافة مساحة إضافية في الأسفل لتوسيع الشاشة -->
        <div class="editor-container">
            <div class="canvas-wrapper-fixed" id="canvasWrapperFixed">
                <canvas id="canvas"></canvas>
                <div class="text-overlay" id="textOverlay" contenteditable="true" spellcheck="false" data-placeholder="اكتب هنا..."></div>
            </div>
            
            <!-- المساحة الإضافية للوحة المفاتيح -->
            <div class="keyboard-space" style="
                height: 300px;
                background: transparent;
                pointer-events: none;
            "></div>

            <!-- أدوات التحرير -->
            <div class="editor-toolbar">
                <button class="tool-btn" onclick="toggleToolPanel('fontPanel')">
                    <span class="material-symbols-outlined">brand_family</span>
                    <span data-lang="font">الخط</span>
                </button>

                <button class="tool-btn" onclick="toggleToolPanel('sizePanel')">
                    <span class="material-symbols-outlined">format_size</span>
                    <span data-lang="size">الحجم</span>
                </button>

                <button class="tool-btn" onclick="toggleToolPanel('colorPanel')">
                    <span class="material-symbols-outlined">colors</span>
                    <span data-lang="color">اللون</span>
                </button>

                <button class="tool-btn" onclick="toggleToolPanel('strokePanel')">
                    <span class="material-symbols-outlined">format_color_text</span>
                    <span data-lang="stroke">الحواف</span>
                </button>

                <button class="tool-btn" onclick="toggleToolPanel('effectsPanel')">
                    <span class="material-symbols-outlined">bedtime</span>
                    <span data-lang="effects">تأثيرات</span>
                </button>
            </div>

            <!-- لوحات الأدوات المنبثقة -->
            <div id="fontPanel" class="tool-panel">
                <select id="fontFamily" class="tool-select"></select>
            </div>

            <div id="sizePanel" class="tool-panel">
                <input type="range" id="fontSize" min="20" max="120" value="48" class="size-slider">
                <span id="fontSizeDisplay">48</span>
            </div>

            <div id="colorPanel" class="tool-panel">
                <div class="color-grid" id="colorGrid"></div>
            </div>

            <div id="strokePanel" class="tool-panel">
                <div class="color-grid" id="strokeColorGrid"></div>
                <input type="range" id="strokeWidth" min="0" max="10" value="3" class="stroke-slider">
                <span id="strokeWidthDisplay">3</span>
            </div>

            <div id="effectsPanel" class="tool-panel">
                <label class="effect-option">
                    <input type="checkbox" id="shadowEnabled" checked>
                    <span data-lang="shadow">ظل</span>
                </label>
                <label class="effect-option">
                    <input type="checkbox" id="cardEnabled">
                    <span data-lang="background">خلفية</span>
                </label>
                <div class="color-grid" id="cardColorGrid"></div>
            </div>
        </div>
    </div>

    <!-- صفحة الإعدادات -->
    <div id="settingsPage" class="page">
        <div class="header">
            <h1 data-lang="settings">الإعدادات</h1>
        </div>
        <div class="settings-content">
            <div class="setting-card">
                <h3 data-lang="theme">السمة</h3>
                <div class="theme-options">
                    <button class="theme-btn active" onclick="changeTheme('light')" data-theme="light">
                        <span data-lang="light">فاتح</span>
                    </button>
                    <button class="theme-btn" onclick="changeTheme('dark')" data-theme="dark">
                        <span data-lang="dark">داكن</span>
                    </button>
                    <button class="theme-btn" onclick="changeTheme('blue')" data-theme="blue">
                        <span data-lang="blue">أزرق</span>
                    </button>
                </div>
            </div>

            <div class="setting-card">
                <h3 data-lang="language">اللغة</h3>
                <div class="language-options">
                    <button class="lang-btn active" onclick="changeLanguage('ar')" data-lang-btn="ar">
                        العربية
                    </button>
                    <button class="lang-btn" onclick="changeLanguage('en')" data-lang-btn="en">
                        English
                    </button>
                    <button class="lang-btn" onclick="changeLanguage('fr')" data-lang-btn="fr">
                        Français
                    </button>
                </div>
            </div>

            <div class="setting-card">
                <a href="https://imgur.com/rMuCo3W" target="_blank" class="setting-link">
                    <span class="material-symbols-outlined">shield</span>
                    <span data-lang="privacy">سياسة الخصوصية</span>
                </a>
                <a href="https://imgur.com/rMuCo3W" target="_blank" class="setting-link">
                    <span class="material-symbols-outlined">info</span>
                    <span data-lang="about">معلومات حول</span>
                </a>
                <a href="https://imgur.com/rMuCo3W" target="_blank" class="setting-link">
                    <span class="material-symbols-outlined">help</span>
                    <span data-lang="help">مركز المساعدة</span>
                </a>
                <a href="https://imgur.com/rMuCo3W" target="_blank" class="setting-link">
                    <span class="material-symbols-outlined">mail</span>
                    <span data-lang="contact">اتصل بنا</span>
                </a>
            </div>

            <div class="setting-card">
                <p style="text-align: center; color: #86868b; font-size: 14px;">
                    <span data-lang="version">الإصدار</span> 4.0
                </p>
            </div>
        </div>
    </div>

    <!-- القائمة السفلية -->
    <div class="bottom-nav">
        <button onclick="showPage('categories')" class="nav-btn active" id="navCategories">
            <span class="material-symbols-outlined">dashboard</span>
            <span data-lang="categories">الفئات</span>
        </button>
        <button onclick="showPage('editor')" class="nav-btn" id="navEditor">
            <span class="material-symbols-outlined">edit</span>
            <span data-lang="editor">التحرير</span>
        </button>
        <button onclick="showPage('settings')" class="nav-btn" id="navSettings">
            <span class="material-symbols-outlined">settings</span>
            <span data-lang="settings">الإعدادات</span>
        </button>
    </div>

    <!-- تحميل الملفات بالترتيب الصحيح -->
    <script src="js/fonts.js"></script>
    <script src="js/colors.js"></script>
    <script src="js/settings.js"></script>
    <script src="js/editor.js"></script>
    <script src="js/app.js"></script>
    
    <script>
        // ============== تحسينات إضافية ==============
        
        // المشكلة 1: تحسين ألوان الصور في المحرر
        function enhanceImageColors(imageUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = function() {
                    try {
                        // إنشاء Canvas مؤقت لتحسين الألوان
                        const tempCanvas = document.createElement('canvas');
                        const tempCtx = tempCanvas.getContext('2d');
                        
                        tempCanvas.width = img.width;
                        tempCanvas.height = img.height;
                        
                        // رسم الصورة
                        tempCtx.drawImage(img, 0, 0);
                        
                        // تحسين الألوان (زيادة التشبع والتباين)
                        const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                        const data = imageData.data;
                        
                        for (let i = 0; i < data.length; i += 4) {
                            // زيادة التشبع
                            let r = data[i];
                            let g = data[i + 1];
                            let b = data[i + 2];
                            
                            // زيادة الإضاءة قليلاً
                            r = Math.min(255, r * 1.05);
                            g = Math.min(255, g * 1.05);
                            b = Math.min(255, b * 1.05);
                            
                            // زيادة التباين
                            const avg = (r + g + b) / 3;
                            const contrast = 1.1;
                            r = avg + contrast * (r - avg);
                            g = avg + contrast * (g - avg);
                            b = avg + contrast * (b - avg);
                            
                            data[i] = r;
                            data[i + 1] = g;
                            data[i + 2] = b;
                        }
                        
                        tempCtx.putImageData(imageData, 0, 0);
                        
                        // تحويل إلى URL
                        const enhancedUrl = tempCanvas.toDataURL('image/jpeg', 0.9);
                        resolve(enhancedUrl);
                        
                    } catch (error) {
                        console.error('خطأ في تحسين الألوان:', error);
                        resolve(imageUrl); // الرجوع للصورة الأصلية في حالة الخطأ
                    }
                };
                
                img.onerror = reject;
                img.src = imageUrl;
            });
        }
        
        // استبدال دالة loadImageToEditor الأصلية
        const originalLoadImageToEditor = window.loadImageToEditor;
        if (originalLoadImageToEditor) {
            window.loadImageToEditor = async function(imageUrl) {
                try {
                    // تحسين ألوان الصورة قبل التحميل
                    showLoadingIndicator('جاري تحسين جودة الصورة...');
                    const enhancedUrl = await enhanceImageColors(imageUrl);
                    hideLoadingIndicator();
                    
                    // تحميل الصورة المحسنة
                    return originalLoadImageToEditor.call(this, enhancedUrl);
                } catch (error) {
                    console.error('خطأ في تحسين الصورة:', error);
                    hideLoadingIndicator();
                    // استخدام الصورة الأصلية في حالة الخطأ
                    return originalLoadImageToEditor.call(this, imageUrl);
                }
            };
        }
        
        // المشكلة 2: تحسين سلوك لوحة المفاتيح
        let originalBodyHeight = '100vh';
        let originalEditorHeight = '';
        
        // دالة لرفع الشاشة عند ظهور لوحة المفاتيح
        function liftScreenForKeyboard() {
            const textOverlay = document.getElementById('textOverlay');
            if (!textOverlay) return;
            
            // حفظ الأبعاد الأصلية
            originalBodyHeight = document.body.style.height;
            originalEditorHeight = document.querySelector('.editor-container').style.height;
            
            // حساب ارتفاع لوحة المفاتيح
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.clientHeight;
            const keyboardHeight = Math.max(0, windowHeight - documentHeight);
            
            if (keyboardHeight > 100) {
                // إضافة كلاس للمؤشر
                document.body.classList.add('keyboard-open');
                document.getElementById('editorPage').classList.add('keyboard-open');
                
                // رفع المحتوى للأعلى
                document.body.style.height = (windowHeight + keyboardHeight) + 'px';
                document.body.style.overflow = 'hidden';
                
                // رفع منطقة المحرر
                const editorContainer = document.querySelector('.editor-container');
                editorContainer.style.height = (windowHeight + keyboardHeight - 140) + 'px';
                editorContainer.style.overflowY = 'auto';
                
                // التركيز على النص ونقله للأعلى
                setTimeout(() => {
                    textOverlay.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
                
                console.log('رفع الشاشة لارتفاع لوحة المفاتيح:', keyboardHeight);
            }
        }
        
        // دالة لاستعادة الشاشة بعد إغلاق لوحة المفاتيح
        function restoreScreenFromKeyboard() {
            document.body.classList.remove('keyboard-open');
            document.getElementById('editorPage').classList.remove('keyboard-open');
            
            // استعادة الأبعاد الأصلية
            document.body.style.height = originalBodyHeight;
            document.body.style.overflow = '';
            
            const editorContainer = document.querySelector('.editor-container');
            if (originalEditorHeight) {
                editorContainer.style.height = originalEditorHeight;
            } else {
                editorContainer.style.height = '';
            }
            editorContainer.style.overflowY = '';
        }
        
        // إضافة مستمعات لوحة المفاتيح المحسنة
        function setupEnhancedKeyboardListeners() {
            const textOverlay = document.getElementById('textOverlay');
            if (textOverlay) {
                // عند التركيز على النص
                textOverlay.addEventListener('focus', () => {
                    setTimeout(liftScreenForKeyboard, 300);
                });
                
                // عند إلغاء التركيز
                textOverlay.addEventListener('blur', () => {
                    setTimeout(() => {
                        if (document.activeElement !== textOverlay) {
                            restoreScreenFromKeyboard();
                        }
                    }, 100);
                });
            }
            
            // مستمع للنافذة
            window.addEventListener('resize', () => {
                setTimeout(() => {
                    const isFocused = document.activeElement === document.getElementById('textOverlay');
                    if (isFocused) {
                        liftScreenForKeyboard();
                    } else {
                        restoreScreenFromKeyboard();
                    }
                }, 100);
            });
        }
        
        // تشغيل المستمعات بعد تحميل الصفحة
        document.addEventListener('DOMContentLoaded', setupEnhancedKeyboardListeners);
        
        // تحميل الصفحة
        window.addEventListener('load', function() {
            console.log('تطبيق محرر الصور المميز جاهز');
            
            // ضبط حجم الصفحة
            document.body.style.height = window.innerHeight + 'px';
            
            // تحميل الألوان
            if (typeof initializeColors === 'function') {
                setTimeout(initializeColors, 500);
            }
            
            // تحسين تجربة اللمس
            document.addEventListener('touchmove', function(e) {
                if (document.body.classList.contains('keyboard-open')) {
                    e.preventDefault();
                }
            }, { passive: false });
        });
        
        // منع السلوك الافتراضي لأزرار التنزيل
        document.addEventListener('DOMContentLoaded', function() {
            const downloadBtn = document.getElementById('downloadBtn');
            const shareBtn = document.getElementById('shareBtn');
            
            if (downloadBtn) {
                downloadBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }, true);
            }
            
            if (shareBtn) {
                shareBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }, true);
            }
        });
    </script>
</body>
</html>
